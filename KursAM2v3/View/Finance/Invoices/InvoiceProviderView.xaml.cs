using System;
using System.ComponentModel;
using System.Linq;
using System.Windows;
using System.Windows.Media;
using Core;
using Core.EntityViewModel;
using Core.ViewModel.Base;
using Core.WindowsManager;
using DevExpress.Data;
using DevExpress.Xpf.Editors;
using DevExpress.Xpf.Editors.Settings;
using DevExpress.Xpf.Grid;
using DevExpress.Xpf.LayoutControl;
using Helper;
using KursAM2.Dialogs;
using KursAM2.ViewModel.Finance.Invoices;
using LayoutManager;

namespace KursAM2.View.Finance.Invoices
{
    /// <summary>
    ///     Interaction logic for InvoiceForm.xaml
    /// </summary>
    public partial class InvoiceProviderView : ILayout
    {
        private LayoutManagerGridAutoGenerationColumns myGridFactsLayout;
        private LayoutManagerGridAutoGenerationColumns myGridPaysLayout;
        private LayoutManagerGridAutoGenerationColumns myGridRowsLayout;

        public ButtonEdit KontrSelectButton;
        public PopupCalcEdit PaySummaEditor;
        private readonly WindowManager myWManager = new WindowManager();

        public InvoiceProviderView()
        {
            InitializeComponent();
            Closing += InvoiceForm_Closing;
            Loaded += InvoiceForm_Loaded;
        }

        public ComboBoxEdit CurrencyItem { set; get; }

        public LayoutManager.LayoutManager LayoutManager { get; set; }
        public string LayoutManagerName { get; set; }

        private void InvoiceForm_Loaded(object sender, RoutedEventArgs e)
        {
            LayoutManager = new LayoutManager.LayoutManager(GetType().Name, this, null);
            myGridRowsLayout = new LayoutManagerGridAutoGenerationColumns(GetType().Name, gridRows);
            myGridFactsLayout = new LayoutManagerGridAutoGenerationColumns(GetType().Name, gridFacts);
            myGridPaysLayout = new LayoutManagerGridAutoGenerationColumns(GetType().Name, gridPays);
            LayoutManager.Load();
        }

        private void InvoiceForm_Closing(object sender, CancelEventArgs e)
        {
            LayoutManager.Save();
            myGridRowsLayout.Save();
            myGridFactsLayout.Save();
            myGridPaysLayout.Save();
        }

        private void LayoutItems_OnAutoGeneratedUI(object sender, EventArgs e)
        {
            foreach (var item in WindowHelper.GetLogicalChildCollection<MemoEdit>(layoutHeaderItems))
                if (item.EditValue != null && !string.IsNullOrWhiteSpace((string) item.EditValue))
                    item.Height = 80;
        }

        private void LayoutItems_OnAutoGeneratingItem(object sender, DataLayoutControlAutoGeneratingItemEventArgs e)
        {
            var ctx = DataContext as ProviderWindowViewModel;
            var doc = ctx?.Document;
            if (doc == null)
                return;
            var oldContent = e.Item.Content as BaseEdit;
            if (e.PropertyType == typeof(decimal) || e.PropertyType == typeof(decimal?))
            {
                var newContent = new PopupCalcEdit
                {
                    DisplayFormatString = "n2",
                    MaskUseAsDisplayFormat = true
                };
                BindingHelper.CopyBinding(oldContent, newContent, BaseEdit.EditValueProperty);
                e.Item.Content = newContent;
            }

            switch (e.PropertyName)
            {
                case nameof(doc.PaySumma):
                    PaySummaEditor = e.Item.Content as PopupCalcEdit;
                    break;
                case nameof(doc.SF_POSTAV_DATE):
                case nameof(doc.SF_REGISTR_DATE):
                    e.Item.HorizontalAlignment = HorizontalAlignment.Left;
                    e.Item.Width = 120;
                    break;
                case nameof(doc.SF_GRUZOOTPRAVITEL):
                case nameof(doc.SF_GRUZOPOLUCHATEL):
                    ViewFluentHelper.SetDefaultMemoEdit(e.Item);
                    e.Item.HorizontalAlignment = HorizontalAlignment.Left;
                    e.Item.MinWidth = 400;
                    break;
                case nameof(doc.SF_CRS_SUMMA):
                case nameof(doc.SummaFact):
                case nameof(doc.SF_KONTR_CRS_SUMMA):
                case nameof(doc.NakladAll):
                    e.Item.HorizontalAlignment = HorizontalAlignment.Left;
                    e.Item.IsReadOnly = true;
                    e.Item.Width = 300;
                    if (e.Item.Content is PopupCalcEdit ed) ed.IsReadOnly = true;

                    break;
                case nameof(doc.Overheads):
                    e.Item.HorizontalAlignment = HorizontalAlignment.Left;
                    break;
                case nameof(doc.SF_POSTAV_NUM):
                    e.Item.HorizontalAlignment = HorizontalAlignment.Left;
                    break;
                case nameof(doc.SF_IN_NUM):
                    e.Item.IsReadOnly = true;
                    e.Item.HorizontalAlignment = HorizontalAlignment.Left;
                    e.Item.Width = 200;
                    break;
                case nameof(doc.Employee):
                    var emplEdit = new ButtonEdit
                    {
                        TextWrapping = TextWrapping.Wrap,
                        IsTextEditable = false
                    };
                    emplEdit.DefaultButtonClick += Employee_DefaultButtonClick;
                    BindingHelper.CopyBinding(oldContent, emplEdit, BaseEdit.EditValueProperty);
                    e.Item.HorizontalAlignment = HorizontalAlignment.Left;
                    e.Item.MinWidth = 200;
                    break;
                case nameof(doc.TABELNUMBER):
                    e.Item.HorizontalAlignment = HorizontalAlignment.Left;
                    break;
                case nameof(doc.CO):
                    ViewFluentHelper.SetComboBoxEdit(e.Item, doc.CO, "CO",
                        MainReferences.COList.Values.ToList().OrderBy(_ => _.Name));
                    e.Item.HorizontalAlignment = HorizontalAlignment.Left;
                    e.Item.HorizontalContentAlignment = HorizontalAlignment.Left;
                    break;
                case nameof(doc.FormRaschet):
                    ViewFluentHelper.SetComboBoxEdit(e.Item, doc.FormRaschet, "FormRaschet",
                        MainReferences.FormRaschets.Values.ToList().OrderBy(_ => _.Name));
                    e.Item.HorizontalAlignment = HorizontalAlignment.Left;
                    e.Item.HorizontalContentAlignment = HorizontalAlignment.Left;
                    break;
                case nameof(doc.PayCondition):
                    ViewFluentHelper.SetComboBoxEdit(e.Item, doc.PayCondition, "PayCondition",
                        MainReferences.PayConditions.Values.ToList().OrderBy(_ => _.Name));
                    e.Item.HorizontalAlignment = HorizontalAlignment.Left;
                    e.Item.HorizontalContentAlignment = HorizontalAlignment.Left;
                    break;
                case nameof(doc.VzaimoraschetType):
                    ViewFluentHelper.SetComboBoxEdit(e.Item, doc.VzaimoraschetType, "VzaimoraschetType",
                        MainReferences.VzaimoraschetTypes.Values.ToList().OrderBy(_ => _.Name));
                    e.Item.HorizontalAlignment = HorizontalAlignment.Left;
                    e.Item.HorizontalContentAlignment = HorizontalAlignment.Left;
                    break;
                case nameof(doc.CREATOR):
                    e.Item.IsReadOnly = true;
                    e.Item.HorizontalAlignment = HorizontalAlignment.Right;
                    break;
                case nameof(doc.Currency):
                    CurrencyItem = ViewFluentHelper.SetComboBoxEdit(e.Item, doc.Currency, "Currency",
                        MainReferences.Currencies.Values.ToList(), width: 50);
                    if (doc.Rows.Count > 0 && doc.State != RowStatus.NewRow)
                        CurrencyItem.IsEnabled = false;
                    break;
                case nameof(doc.Kontragent):
                    KontrSelectButton = new ButtonEdit
                    {
                        TextWrapping = TextWrapping.Wrap,
                        IsTextEditable = false,
                        Tag = e.PropertyName
                    };
                    KontrSelectButton.DefaultButtonClick += Kontr_DefaultButtonClick;
                    BindingHelper.CopyBinding(oldContent, KontrSelectButton, BaseEdit.EditValueProperty);
                    e.Item.Content = KontrSelectButton;
                    e.Item.MinWidth = 500;
                    e.Item.HorizontalAlignment = HorizontalAlignment.Left;
                    break;
                case nameof(doc.KontrReceiver):
                    var kontrEdit = new ButtonEdit
                    {
                        TextWrapping = TextWrapping.Wrap,
                        IsTextEditable = false,
                        Tag = e.PropertyName
                    };
                    kontrEdit.DefaultButtonClick += Kontr_DefaultButtonClick;
                    BindingHelper.CopyBinding(oldContent, kontrEdit, BaseEdit.EditValueProperty);
                    e.Item.Content = kontrEdit;
                    e.Item.MinWidth = 500;
                    e.Item.HorizontalAlignment = HorizontalAlignment.Left;
                    break;
                case "State":
                    e.Item.IsReadOnly = true;
                    if (e.Item.Content is ComboBoxEdit cbState) cbState.IsEnabled = false;
                    e.Item.HorizontalAlignment = HorizontalAlignment.Right;
                    break;
                case nameof(doc.SF_NOTES):
                    ViewFluentHelper.SetDefaultMemoEdit(e.Item);
                    e.Item.HorizontalAlignment = HorizontalAlignment.Left;
                    e.Item.MinWidth = 500;
                    e.Item.MinHeight = 80;
                    break;
                case nameof(InvoiceClient.PersonaResponsible):
                    var cb = ViewFluentHelper.SetComboBoxEdit(e.Item, doc.PersonaResponsible, "PersonaResponsible",
                        MainReferences.Employees.Values.ToList().OrderBy(_ => _.Name));
                    var delBtn = new ButtonInfo
                    {
                        GlyphKind = GlyphKind.Cancel
                    };
                    delBtn.Click += DelBtn_Click;
                    cb.Buttons.Add(delBtn);
                    e.Item.HorizontalAlignment = HorizontalAlignment.Left;
                    e.Item.HorizontalContentAlignment = HorizontalAlignment.Left;
                    e.Item.MinWidth = 600;
                    break;
                case nameof(doc.Contract):
                    e.Item.HorizontalAlignment = HorizontalAlignment.Left;
                    e.Item.MinWidth = 300;
                    break;
            }

            ViewFluentHelper.SetModeUpdateProperties(doc, e.Item, e.PropertyName);
        }

        private void DelBtn_Click(object sender, RoutedEventArgs e)
        {
            var ctx = DataContext as ProviderWindowViewModel;
            var doc = ctx?.Document;
            if (doc == null)
                return;
            doc.PersonaResponsible = null;
        }

        private void Kontr_DefaultButtonClick(object sender, RoutedEventArgs e)
        {
            var ctx = DataContext as ProviderWindowViewModel;
            var doc = ctx?.Document;
            if (doc == null)
                return;
            if (doc.PaySumma != 0)
            {
                WindowManager.ShowMessage("По счету есть Оплата. Изменить контрагента нельзя.",
                    "Предупреждение", MessageBoxImage.Information);
                return;
            }

            var kontr = StandartDialogs.SelectKontragent();
            if (kontr == null) return;
            if ((string) (sender as ButtonEdit)?.Tag == "Kontragent")
            {
                ctx.Document.Kontragent = kontr;
                ctx.Document.Currency = kontr.BalansCurrency;
                CurrencyItem.IsEnabled = false;
            }
            else
            {
                ctx.Document.KontrReceiver = kontr;
            }
        }

        private void Employee_DefaultButtonClick(object sender, RoutedEventArgs e)
        {
            var ctx = DataContext as ProviderWindowViewModel;
            var doc = ctx?.Document;
            if (doc == null)
                return;
            var emp = StandartDialogs.SelectEmployee();
            if (emp != null) ctx.Document.Employee = emp;
        }

        private void GridRows_OnAutoGeneratingColumn(object sender, AutoGeneratingColumnEventArgs e)
        {
            e.Column.Name = e.Column.FieldName;
            if (KursGridControlHelper.ColumnFieldTypeCheckDecimal(e.Column.FieldType))
                e.Column.EditSettings = new CalcEditSettings
                {
                    DisplayFormat = "n2",
                    Name = e.Column.FieldName + "Calc"
                };
            var ctx = DataContext as ProviderWindowViewModel;
            var doc = ctx?.Document;
            if (doc == null)
                return;
            // ReSharper disable once LocalNameCapturedOnly
            // ReSharper disable once RedundantAssignment
            // ReSharper disable once EntityNameCapturedOnly.Local
            var row = new InvoiceProviderRow();
            switch (e.Column.Name)
            {
                case nameof(row.Unit):
                case nameof(row.NomenklNumber):
                    e.Column.ReadOnly = true;
                    break;
                case nameof(row.Nomenkl):
                    var nomenklEdit = new ButtonEditSettings
                    {
                        TextWrapping = TextWrapping.Wrap,
                        IsTextEditable = false
                    };
                    nomenklEdit.DefaultButtonClick += Nomenkl_DefaultButtonClick;
                    e.Column.EditSettings = nomenklEdit;
                    break;
                case nameof(row.Note):
                    e.Column.EditSettings = new MemoEditSettings
                    {
                        ShowIcon = false
                    };
                    break;
                case nameof(row.KontragentForNaklad):
                    var kontrForNakladEdit = new ButtonEditSettings
                    {
                        TextWrapping = TextWrapping.Wrap,
                        IsTextEditable = false
                    };
                    kontrForNakladEdit.DefaultButtonClick += kontrForNaklad_DefaultButtonClick;
                    e.Column.EditSettings = kontrForNakladEdit;
                    break;
                case nameof(row.SDRSchet):
                    e.Column.EditSettings = new ComboBoxEditSettings
                    {
                        ItemsSource = MainReferences.SDRSchets.Values,
                        DisplayMember = "Name",
                        AutoComplete = true
                    };
                    break;
            }
        }

        private void kontrForNaklad_DefaultButtonClick(object sender, RoutedEventArgs e)
        {
            var ctx = DataContext as ProviderWindowViewModel;
            var doc = ctx?.Document;
            if (doc == null)
                return;
            if (ctx.CurrentRow == null) return;
            var kontr = StandartDialogs.SelectKontragent();
            if (kontr == null) return;
            ctx.CurrentRow.KontragentForNaklad = kontr;
        }

        private void Nomenkl_DefaultButtonClick(object sender, RoutedEventArgs e)
        {
            decimal defaultNDS;
            var ctx = DataContext as ProviderWindowViewModel;
            var doc = ctx?.Document;
            if (doc == null)
                return;
            var nomenkls = StandartDialogs.SelectNomenkls();
            if (nomenkls == null || nomenkls.Count <= 0) return;
            using (var entctx = GlobalOptions.GetEntities())
            {
                defaultNDS = Convert.ToDecimal(entctx.PROFILE
                    .FirstOrDefault(_ => _.SECTION == "НОМЕНКЛАТУРА" && _.ITEM == "НДС")?.ITEM_VALUE);
            }

            ctx.CurrentRow.Nomenkl = nomenkls.First();
            ctx.CurrentRow.SFT_NDS_PERCENT = ctx.CurrentRow.Nomenkl.NDSPercent ?? defaultNDS;
        }

        private void GridRows_OnAutoGeneratedColumns(object sender, RoutedEventArgs e)
        {
            //gridRowsLayout = new LayoutManagerGridAutoGenerationColumns(GetType().Name, gridRows);
            LayoutManager.RegistrControlLayouts(myGridRowsLayout);
            var columnsInfo = myGridRowsLayout.Load();
            gridRows.TotalSummary.Clear();
            gridRows.BeginInit();
            foreach (var col in gridRows.Columns)
            {
                myGridRowsLayout.AutoGeneratedColumnSetProperties(columnsInfo.ColumnsInfo, col);
                if (col.EditSettings == null)
                    col.EditSettings = new TextEditSettings
                    {
                        SelectAllOnMouseUp = true
                    };
            }

            gridRows.EndInit();
        }

        private void GridFacts_OnAutoGeneratingColumn(object sender, AutoGeneratingColumnEventArgs e)
        {
            foreach (var c in gridFacts.Columns)
                if (c.EditSettings == null)
                    c.EditSettings = new TextEditSettings
                    {
                        SelectAllOnMouseUp = true
                    };

            myGridFactsLayout = new LayoutManagerGridAutoGenerationColumns(GetType().Name, gridFacts);
            LayoutManager.RegistrControlLayouts(myGridFactsLayout);
            var columnsInfo = myGridFactsLayout.Load();
            gridFacts.TotalSummary.Clear();
            gridFacts.BeginInit();
            foreach (var col in gridFacts.Columns)
                myGridFactsLayout.AutoGeneratedColumnSetProperties(columnsInfo.ColumnsInfo, col);
            gridFacts.EndInit();
        }

        private void GridFacts_OnAutoGeneratedColumns(object sender, RoutedEventArgs e)
        {
            var columnsInfo = myGridFactsLayout.Load();
            gridFacts.TotalSummary.Clear();
            foreach (var col in gridFacts.Columns)
                myGridFactsLayout.AutoGeneratedColumnSetProperties(columnsInfo.ColumnsInfo, col);
        }

        private void LayoutHeaderItems_OnAutoGeneratedGroup(object sender,
            DataLayoutControlAutoGeneratedGroupEventArgs e)
        {
            switch (e.Group.Header)
            {
                case "Условия":
                    e.Group.HorizontalAlignment = HorizontalAlignment.Left;
                    break;
            }
        }

        private void GridPays_OnAutoGeneratingColumn(object sender, AutoGeneratingColumnEventArgs e)
        {
            e.Column.Name = e.Column.FieldName;
            if (KursGridControlHelper.ColumnFieldTypeCheckDecimal(e.Column.FieldType))
                e.Column.EditSettings = new CalcEditSettings
                {
                    DisplayFormat = "n2",
                    Name = e.Column.FieldName + "Calc"
                };
        }

        private void GridPays_OnAutoGeneratedColumns(object sender, RoutedEventArgs e)
        {
            myGridPaysLayout = new LayoutManagerGridAutoGenerationColumns(GetType().Name, gridPays);
            LayoutManager.RegistrControlLayouts(myGridPaysLayout);
            var columnsInfo = myGridPaysLayout.Load();
            gridPays.TotalSummary.Clear();
            gridPays.BeginInit();
            gridPays.CustomSummary += GridPays_OnCustomSummary;
            foreach (var col in gridPays.Columns)
            {
                myGridPaysLayout.AutoGeneratedColumnSetProperties(columnsInfo.ColumnsInfo, col);
                if (col.EditSettings == null)
                    col.EditSettings = new TextEditSettings
                    {
                        SelectAllOnMouseUp = true
                    };
                if (col.FieldName != "Summa" && col.FieldName != "Note" && col.FieldName != "Rate")
                    col.ReadOnly = true;
                else
                    col.ReadOnly = false;

                if (KursGridControlHelper.ColumnFieldTypeCheckDecimal(col.FieldType))
                {
                    if (col.FieldName == "Rate")
                    {
                        var p = hasPaysTotalSummary(col.FieldName);
                        if (p == null) continue;
                        p.SummaryType = SummaryItemType.Custom;
                        p.DisplayFormat = "n4";
                    }
                    else
                    {
                        if (hasPaysTotalSummary(col.FieldName) != null) continue;
                        gridPays.TotalSummary.Add(new GridSummaryItem
                        {
                            FieldName = col.FieldName,
                            SummaryType = SummaryItemType.Sum,
                            DisplayFormat = "n2"
                        });
                    }
                }
            }

            gridPays.EndInit();
        }

        private GridSummaryItem hasPaysTotalSummary(string fName)
        {
            foreach (var ts in gridPays.TotalSummary)
                if (ts.FieldName == fName)
                    return ts;
            return null;
        }

        private void TableView_CellValueChanged(object sender, CellValueChangedEventArgs e)
        {
            if (!(DataContext is ProviderWindowViewModel dtx)) return;
            switch (e.Column.FieldName)
            {
                case nameof(InvoiceProviderRowCurrencyConvertViewModel.Rate):
                    dtx.CurrentCrsConvertItem.CalcRow(DirectCalc.Rate);
                    break;
                case nameof(InvoiceProviderRowCurrencyConvertViewModel.Price):
                    dtx.CurrentCrsConvertItem.CalcRow(DirectCalc.Price);
                    break;
                case nameof(InvoiceProviderRowCurrencyConvertViewModel.PriceWithNaklad):
                    dtx.CurrentCrsConvertItem.CalcRow(DirectCalc.PriceWithNaklad);
                    break;
                case nameof(InvoiceProviderRowCurrencyConvertViewModel.Quantity):
                    dtx.CurrentCrsConvertItem.CalcRow(DirectCalc.Quantity);
                    break;
            }

            if (dtx.CurrentRow == null)
            {
                var row = dtx.Document.Rows.FirstOrDefault(_ => _.Code == dtx.CurrentCrsConvertItem.Code);
                if (row != null)
                    row.State = RowStatus.Edited;
            }
            else
            {
                dtx.CurrentRow.State = RowStatus.Edited;
            }
        }

        private void gridRows_MasterRowExpanding(object sender, RowAllowEventArgs e)
        {
            if (DataContext is ProviderWindowViewModel dtx) dtx.CurrentRow = (InvoiceProviderRow) e.Row;
        }

        private void TableViewPay_OnCellValueChanged(object sender, CellValueChangedEventArgs e)
        {
            if (!(DataContext is ProviderWindowViewModel dtx)) return;
            if (e.Column.FieldName == "Summa")
            {
                if ((decimal) e.Value < 0 || (decimal) e.Value > dtx.CurrentPaymentDoc.DocSumma)
                {
                    myWManager.ShowWinUIMessageBox("Сумма не может быть меньше 0 и больше суммы документа",
                        "Ошибка", MessageBoxButton.OK, MessageBoxImage.Error);
                    dtx.CurrentPaymentDoc.Summa = dtx.CurrentPaymentDoc.DocSumma;
                    tableViewPay.CloseEditor();
                }
            }

            if (dtx.Document.myState != RowStatus.NewRow)
                dtx.Document.myState = RowStatus.Edited;

            PaySummaEditor.Foreground = dtx.Document.PaySumma > dtx.Document.SF_CRS_SUMMA
                ? new SolidColorBrush(Colors.Red)
                : new SolidColorBrush(Colors.Black);
            dtx.Document.RaisePropertyChanged("PaySumma");
            dtx.RaisePropertyChanged("Document");
        }

        private void GridPays_OnCustomSummary(object sender, CustomSummaryEventArgs e)
        {
            var dtx = DataContext as ProviderWindowViewModel;
            if (dtx == null) return;
            if (((GridSummaryItem) e.Item).FieldName != "Rate")
                return;
            if (e.IsTotalSummary)
                if (e.SummaryProcess == CustomSummaryProcess.Calculate)
                {
                    var s = 0.0m;
                    var sr = 0.0m;
                    foreach (var item in dtx.Document.PaymentDocs)
                    {
                        s += item.Summa * item.Rate;
                        sr += item.Summa;
                    }

                    e.TotalValue = sr != 0
                        ? Math.Round(s / sr, 4)
                        : Math.Round(dtx.Document.PaymentDocs.Sum(_ => _.Rate) / dtx.Document.PaymentDocs.Count, 4);
                }
        }
    }
}